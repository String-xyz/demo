var stringpay=function(e){"use strict";var t=function e(t){function r(e,t,n){var a,o={};if(Array.isArray(e))return e.concat(t);for(a in e)o[n?a.toLowerCase():a]=e[a];for(a in t){var i=n?a.toLowerCase():a,s=t[a];o[i]=i in o&&"object"==typeof s?r(o[i],s,"headers"==i):s}return o}function n(e,n,a,o,i){var s="string"!=typeof e?(n=e).url:e,c={config:n},u=r(t,n),d={};o=o||u.data,(u.transformRequest||[]).map((function(e){o=e(o,u.headers)||o})),u.auth&&(d.authorization=u.auth),o&&"object"==typeof o&&"function"!=typeof o.append&&"function"!=typeof o.text&&(o=JSON.stringify(o),d["content-type"]="application/json");try{d[u.xsrfHeaderName]=decodeURIComponent(document.cookie.match(RegExp("(^|; )"+u.xsrfCookieName+"=([^;]*)"))[2])}catch(e){}return u.baseURL&&(s=s.replace(/^(?!.*\/\/)\/?/,u.baseURL+"/")),u.params&&(s+=(~s.indexOf("?")?"&":"?")+(u.paramsSerializer?u.paramsSerializer(u.params):new URLSearchParams(u.params))),(u.fetch||fetch)(s,{method:(a||u.method||"get").toUpperCase(),body:o,headers:r(u.headers,d,!0),credentials:u.withCredentials?"include":i}).then((function(e){for(var t in e)"function"!=typeof e[t]&&(c[t]=e[t]);return"stream"==u.responseType?(c.data=e.body,c):e[u.responseType||"text"]().then((function(e){c.data=e,c.data=JSON.parse(e)})).catch(Object).then((function(){return(u.validateStatus?u.validateStatus(e.status):e.ok)?c:Promise.reject(c)}))}))}return t=t||{},n.request=n,n.get=function(e,t){return n(e,t,"get")},n.delete=function(e,t){return n(e,t,"delete")},n.head=function(e,t){return n(e,t,"head")},n.options=function(e,t){return n(e,t,"options")},n.post=function(e,t,r){return n(e,r,"post",t)},n.put=function(e,t,r){return n(e,r,"put",t)},n.patch=function(e,t,r){return n(e,r,"patch",t)},n.all=Promise.all.bind(Promise),n.spread=function(e){return e.apply.bind(e,e)},n.CancelToken="function"==typeof AbortController?AbortController:Object,n.defaults=t,n.create=e,n}();var r=function(){return r=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},r.apply(this,arguments)};var n={default:"endpoint"};function a(e,t){var r=[];return function(e,t){var r,n,a=(n=function(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var n=Array(e),a=0;for(t=0;t<r;t++)for(var o=arguments[t],i=0,s=o.length;i<s;i++,a++)n[a]=o[i];return n}(e),{current:function(){return n[0]},postpone:function(){var e=n.shift();void 0!==e&&n.push(e)},exclude:function(){n.shift()}}),o=(100,3e3,r=0,function(){return Math.random()*Math.min(3e3,100*Math.pow(2,r++))}),i=a.current();if(void 0===i)return Promise.reject(new TypeError("The list of script URL patterns is empty"));var s=function(e,r){return t(e).catch((function(e){if(r+1>=5)throw e;!function(e){if(!(e instanceof Error))return!1;var t=e.message;return"Blocked by CSP"===t||"9319"===t}(e)?a.postpone():a.exclude();var t,n=a.current();if(void 0===n)throw e;return(t=o(),new Promise((function(e){return setTimeout(e,t)}))).then((function(){return s(n,r+1)}))}))};return s(i,0)}(e,(function(e){var n=new Date,a=function(){return r.push({url:e,startedAt:n,finishedAt:new Date})},o=t(e);return o.then(a,a),o})).then((function(e){return[e,{attempts:r}]}))}var o="Failed to load the JS script of the agent";function i(e){var t;e.scriptUrlPattern;var n=e.token,o=e.apiKey,i=void 0===o?n:o,c=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(n=Object.getOwnPropertySymbols(e);a<n.length;a++)t.indexOf(n[a])<0&&Object.prototype.propertyIsEnumerable.call(e,n[a])&&(r[n[a]]=e[n[a]])}return r}(e,["scriptUrlPattern","token","apiKey"]),d=null!==(t=function(e,t){return function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}(e,t)?e[t]:void 0}(e,"scriptUrlPattern"))&&void 0!==t?t:"https://fpnpmcdn.net/v<version>/<apiKey>/loader_v<loaderVersion>.js";return Promise.resolve().then((function(){if(!i||"string"!=typeof i)throw new Error("API key required");return a(function(e,t){return(Array.isArray(e)?e:[e]).map((function(e){return function(e,t){var r=encodeURIComponent;return e.replace(/<[^<>]+>/g,(function(e){return"<version>"===e?"3":"<apiKey>"===e?r(t):"<loaderVersion>"===e?r("3.8.1"):e}))}(String(e),t)}))}(d,i),s).catch(u)})).then((function(e){var t=e[0],n=e[1];return t.load(r(r({},c),{ldi:n}))}))}function s(e){return function(e,t,r,n){var a,o=document,i="securitypolicyviolation",s=function(t){var r=new URL(e,location.href),n=t.blockedURI;n!==r.href&&n!==r.protocol.slice(0,-1)&&n!==r.origin||(a=t,c())};o.addEventListener(i,s);var c=function(){return o.removeEventListener(i,s)};return Promise.resolve().then(t).then((function(e){return c(),e}),(function(e){return new Promise((function(e){return setTimeout(e)})).then((function(){if(c(),a)return function(){throw new Error("Blocked by CSP")}();throw e}))}))}(e,(function(){return function(e){return new Promise((function(t,r){var n=document.createElement("script"),a=function(){var e;return null===(e=n.parentNode)||void 0===e?void 0:e.removeChild(n)},i=document.head||document.getElementsByTagName("head")[0];n.onload=function(){a(),t()},n.onerror=function(){a(),r(new Error(o))},n.async=!0,n.src=e,i.appendChild(n)}))}(e)})).then(c)}function c(){var e=window,t="__fpjs_p_l_b",r=e[t];if(function(e,t){var r,n=null===(r=Object.getOwnPropertyDescriptor)||void 0===r?void 0:r.call(Object,e,t);(null==n?void 0:n.configurable)?delete e[t]:n&&!n.writable||(e[t]=void 0)}(e,t),"function"!=typeof(null==r?void 0:r.load))throw new Error("9319");return r}function u(e){throw e instanceof Error&&"9319"===e.message?new Error(o):e}function d({apiClient:e,locationService:t}){const r={signature:"",nonce:""},n=async(e,t)=>{try{const r=window.atob(t);return await window.ethereum.request({method:"personal_sign",params:[r,e]})}catch(e){console.log("SDK :: Wallet signature error: ",e)}};return{loginOrCreateUser:async a=>{const{nonce:o}=await e.requestLogin(a),i=await n(a,o),s=await t.getVisitorData();r.nonce=o,r.signature=i;try{return await e.createUser(o,i,s)}catch(t){if("CONFLICT"===t.code)return(async(t,r,n)=>await e.loginUser(t,r,n))(o,i,s);throw t}},retryLogin:async()=>{if(!r.signature)throw{code:"UNAUTHORIZED"};const n=await t.getVisitorData();return await e.loginUser(r.nonce,r.signature,n)},logout:async()=>{try{await e.logoutUser()}catch{return}},fetchLoggedInUser:async t=>{try{const{user:r}=await e.refreshToken(t);return r}catch(e){return null}}}}const l="STRING_PAY",f=new URL("https://iframe-app.dev.string-api.xyz").origin;var p;!function(e){e.LOAD_PAYLOAD="load_payload",e.IFRAME_READY="ready",e.IFRAME_RESIZE="resize",e.IFRAME_CLOSE="close",e.REQUEST_AUTHORIZE_USER="request_authorize_user",e.RECEIVE_AUTHORIZE_USER="receive_authorize_user",e.REQUEST_RETRY_LOGIN="request_retry_login",e.RECEIVE_RETRY_LOGIN="receive_retry_login",e.REQUEST_UPDATE_USER="request_update_user",e.RECEIVE_UPDATE_USER="receive_update_user",e.REQUEST_EMAIL_VERIFICATION="request_email_verification",e.RECEIVE_EMAIL_VERIFICATION="receive_email_verification",e.REQUEST_CONFIRM_TRANSACTION="request_confirm_transaction",e.RECEIVE_CONFIRM_TRANSACTION="receive_confirm_transaction",e.REQUEST_QUOTE_START="request_quote_start",e.QUOTE_CHANGED="quote_changed",e.REQUEST_QUOTE_STOP="request_quote_stop"}(p||(p={}));const y={},h=async e=>{if(e.origin!==f)return;const t=window.StringPay;try{const r=JSON.parse(e.data),n=r.channel,a=r.event;if(n===l){const e=y[a.eventName];e?await e(a,t):console.debug("SDK :: Unhandled event: ",a)}}catch(e){console.error("sdk: _handleEvent error: ",e)}},E=()=>{w(),window.addEventListener("message",h)},w=()=>{window.removeEventListener("message",h)};function m(){w(),window.StringPay&&(window.StringPay.frame?.remove(),window.StringPay.frame=void 0,window.StringPay.isLoaded=!1,window.StringPay.onFrameClose())}function g(e,t,r,n){const a=(e,t,r,n)=>{var a;e||(a="a frame was not provided to sendEvent",console.error("[String Pay] "+a));const o={eventName:t,data:r,error:n},i=JSON.stringify({channel:l,event:o});e.contentWindow?.postMessage(i,"*")};return y[p.IFRAME_READY]=async function(t,o){let i=null;if(!o.frame||!o.payload)throw new Error("Iframe not ready");r.setWalletAddress(o.payload.userAddress),r.setApiKey(o.payload.apiKey),n.getFPInstance().catch((e=>console.debug("getFPInstance error: ",e)));try{i=await e.fetchLoggedInUser(o.payload.userAddress)}catch(e){console.debug("fetchLoggedInUser error",e)}const s=(c=o.payload,u=i,{nft:{name:c.name,price:c.price,currency:c.currency,collection:c.collection??"",imageSrc:c.imageSrc,imageAlt:c?.imageAlt??"NFT"},user:{walletAddress:c.userAddress,id:u?.id??"",status:u?.status??"",email:u?.email??""}});var c,u;a(o.frame,p.LOAD_PAYLOAD,s),o.isLoaded=!0,o.onFrameLoad()},y[p.IFRAME_CLOSE]=async function(){console.debug("SDK :: onIframeClose"),t.stopQuote(),m()},y[p.IFRAME_RESIZE]=async function(e,t){if(!t.frame||!t.payload)throw new Error("Iframe not ready");const r=t.frame;e.data?.height!=r.scrollHeight&&(r.style.height=(e.data?.height??r.scrollHeight)+"px")},y[p.REQUEST_AUTHORIZE_USER]=async function(t,r){if(!r.frame||!r.payload)throw new Error("Iframe not ready");try{const{user:t}=await e.loginOrCreateUser(r.payload.userAddress);a(r.frame,p.RECEIVE_AUTHORIZE_USER,{user:t})}catch(e){console.debug("SDK :: onAuthorizeUser error: ",e),a(r.frame,p.RECEIVE_AUTHORIZE_USER,{},e)}},y[p.REQUEST_RETRY_LOGIN]=async function(t,{frame:r}){if(!r)throw new Error("Iframe not ready");try{const{user:t}=await e.retryLogin();a(r,p.RECEIVE_RETRY_LOGIN,{user:t})}catch(e){a(r,p.RECEIVE_RETRY_LOGIN,{},e)}},y[p.REQUEST_UPDATE_USER]=async function(e,{frame:t}){if(!t)throw new Error("Iframe not ready");try{const n=e.data,o=await r.updateUser(n.userId,n.update);a(t,p.RECEIVE_UPDATE_USER,{user:o})}catch(e){a(t,p.RECEIVE_UPDATE_USER,{},e)}},y[p.REQUEST_EMAIL_VERIFICATION]=async function(e,{frame:t}){if(!t)throw new Error("Iframe not ready");try{const n=e.data;await r.requestEmailVerification(n.userId,n.email),a(t,p.RECEIVE_EMAIL_VERIFICATION,{status:"email_verified"})}catch(e){a(t,p.RECEIVE_EMAIL_VERIFICATION,{},e)}},y[p.REQUEST_QUOTE_START]=async function(e,{frame:r,payload:n}){if(!r)throw new Error("Iframe not ready");const o=n;t.startQuote(o,(e=>a(r,p.QUOTE_CHANGED,{quote:e})))},y[p.REQUEST_QUOTE_STOP]=async function(){t.stopQuote()},y[p.REQUEST_CONFIRM_TRANSACTION]=async function(e,{frame:t}){if(!t)throw new Error("Iframe not ready");try{const n=e.data,o=await r.transact(n);a(t,p.RECEIVE_CONFIRM_TRANSACTION,o)}catch(e){a(t,p.RECEIVE_CONFIRM_TRANSACTION,{},e)}},window.ethereum.removeAllListeners("accountsChanged"),window.ethereum.on("accountsChanged",(e=>{r.setWalletAddress(e[0]),r.logoutUser(),m(),t.stopQuote()})),{registerEvents:E,unregisterEvents:w,sendEvent:a}}function v({apiUrl:e}){const r=function({baseUrl:e}){let r="",n="";const a=t.create({baseURL:e,headers:{"Content-Type":"application/json"},withCredentials:!0}),o=e=>r=e;async function i(e){const t={"X-Api-Key":n};try{const{data:r}=await a.post("/login/refresh",{walletAddress:e},{headers:t});return console.log(" - Token was refreshed"),r}catch(e){throw s(e)}}function s(e){return e.data?e.data:e.response?e.response.data:e.request?e.request:e.message?e.message:e}async function c(e){try{return await e()}catch(t){const n=t.config;if(401===t.status&&!function(e){return"/login/refresh"===e.url}(n)&&await i(r))return e();throw t}}return{createApiKey:async function(){const{data:e}=await a.post("/apikeys");return e},getApiKeys:async function(e=10){const{data:t}=await a.get("/apikeys",{params:{limit:e}});return t},validateApiKey:async function(e){const{data:t}=await a.post(`/apikeys/${e}/approve`);return t},requestLogin:async function(e){o(e);try{const e={"X-Api-Key":n},{data:t}=await a.get("/login",{params:{walletAddress:r},headers:e});return t}catch(e){throw s(e)}},createUser:async function(e,t,r){const o={"X-Api-Key":n},i={nonce:e,signature:t,fingerprint:r};try{const{data:e}=await a.post("/users",i,{headers:o});return e}catch(e){throw s(e)}},updateUser:async function(e,t){const{data:r}=await c((()=>a.put(`/users/${e}`,t,{headers:{"X-Api-Key":n}})));return r},requestEmailVerification:async function(e,t){try{const r=()=>a.get(`/users/${e}/verify-email`,{headers:{"X-Api-Key":n},params:{email:t}});await c(r)}catch(e){throw s(e)}},loginUser:async function(e,t,r){const o={"X-Api-Key":n},i={nonce:e,signature:t,fingerprint:r};try{const{data:e}=await a.post("/login/sign",i,{headers:o});return e}catch(e){throw s(e)}},refreshToken:i,logoutUser:async function(){const e={"X-Api-Key":n};try{const{status:t}=await a.post("/login/logout",{},{headers:e});if(204===t)return;throw new Error("logout failed")}catch(e){throw s(e)}},getUserStatus:async function(e){if(!e)throw new Error("userId is required");const t={"X-Api-Key":n};try{const r=()=>a.get(`/users/${e}/status`,{headers:t}),{data:n}=await c(r);return n}catch(e){throw s(e)}},getQuote:async function(e){const t={"X-Api-Key":n};try{const r=()=>a.post("/quotes",e,{headers:t}),{data:n}=await c(r);return n}catch(e){throw s(e)}},transact:async function(e){const t={"X-Api-Key":n};try{const r=()=>a.post("/transactions",e,{headers:t}),{data:n}=await c(r);return n}catch(e){throw s(e)}},setWalletAddress:o,setApiKey:e=>n=e}}({baseUrl:e}),a=function(e={}){let t;async function r(){const r={apiKey:"nmYB7RHc1vaGnBNRwtbe",endpoint:["https://metrics.string.xyz",n],...e};return t||(t=await i(r)),t}return{getFPInstance:r,getVisitorData:async function(e={extendedResult:!0}){try{const t=await r();return await t.get(e)}catch(e){return void console.debug("analytics service error:",e)}}}}(),o=d({apiClient:r,locationService:a}),s=function(e){let t;async function r(t,r){try{r(await e.getQuote(t))}catch(e){console.debug("-- refresh quote error --",e)}}return{startQuote:async function(e,n){r(e,n),t&&clearInterval(t),t=setInterval((()=>r(e,n)),1e4)},stopQuote:function(){clearInterval(t),t=void 0},refreshQuote:r}}(r);return{apiClient:r,locationService:a,authService:o,quoteService:s,eventsService:g(o,s,r,a)}}const _=e=>{console.error("[String Pay] "+e)};class R{container;frame;payload;isLoaded=!1;services;_loadIframeCallback=()=>{};constructor(e){this._loadIframeCallback=e}onFrameLoad=()=>{};onFrameClose=()=>{};async loadFrame(e){if(!window.ethereum||!window.ethereum.selectedAddress)return _("No wallet connected, please connect wallet");const t=document.querySelector(".string-pay-frame");if(!t)return _("Unable to load String Frame, element 'string-pay-frame' does not exist");for(;t.firstChild;)t.removeChild(t.firstChild);if(!e)return _("No payload specified");if(!e.apiKey)return _("You must have an api key in your payload");if("str."!==e.apiKey.slice(0,4))return _(`Invalid API Key: ${e.apiKey}`);if(!e.userAddress)return _("No user address found, please connect wallet");this.payload=e;const r=document.createElement("iframe");r.style.width="100vh",r.style.height="700px",r.style.overflow="none",r.src="https://iframe-app.dev.string-api.xyz",t.appendChild(r),this.container=t,this.frame=r,this.payload.gasLimit="8000000",this._loadIframeCallback()}}return function(){const e=v({apiUrl:"https://api.sandbox.string-api.xyz"}),t=new R((()=>{e.eventsService.unregisterEvents(),e.eventsService.registerEvents()}));window.StringPay=t}(),e.StringPay=R,e}({});
